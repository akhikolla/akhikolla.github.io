---
title: Rcpp Packages Limited Fuzz Testing
author: Akhila Chowdary Kolla
categories: [Testing, Memory checks]
tags: [FuzzTesting]
math: true
---

**Limited Fuzz Testing**

**Background**

	Testing a software application is always a tough job and time-consuming. To successfully identify bugs in your package we need to consider the following:

1. Randomized Inputs.
2. Code Coverage
3. Learned Inputs

We should be able to pass both valid and invalid inputs to test the package. The inputs that are generated should be able to test every line of the code efficiently. The most important thing we need to consider while testing an application is to make sure that we don't pass the same inputs again and again instead we should be able to learn from the previous inputs and try to uncover bugs if there are any.

DeepState is one such tool that supports all the three features and helps us test the packages. The inputs generated by the DeepState_* function are random and covers most of the code. It generates tuned inputs to discover more bugs in the package. 

As a part of the RcppDeepState, We are testing the Rcpp packages with the help of a deepstate testing framework. The RcppDeepState helps us find the subtle bugs in the packages.


### CRAN checks on Rcpp Packages

As discussed earlier RcppDeepState uses a combination of deepstate and Valgrind to reveal the subtle bugs in the code.DeepState is for generating the learned inputs and valgrind to test the code using those inputs. An interesting thing about RcppDeepState is that it's able to detect the bugs in few Rcpp packages where CRAN failed to detect. 

CRAN tests its packages against the different kinds of checks. Those check include valgrind,clang-ASAN,clang-UBSAN,gcc-ASAN,gcc-UBSAN,clang11,gcc10,noLD,ATLAS,MKL,OpenBLAS,LTO,noOMP,donttest,rchk,rcnst. The [CRAN check](https://cran.r-project.org/web/checks/check_issue_kinds.html) page provides more detailed explaination of these tools.

Issues in the packages are mostly identified by Address sanitizers, undefined behaviour sanitizer and Valgrind. The below data table list the most frequent tools and count of packages that tools identified the errors in: 

```R

> type.dt[, .(pkgs=.N), by=type][order(pkgs)]
          type pkgs
1:  clang-ASAN    1
2:    gcc-ASAN    1
3:   gcc-UBSAN   12
4:    valgrind   18
5: clang-UBSAN   26

```

We downloaded CRAN check pages for all the Rcpp packages and tried to identify the packages with bugs in them. The [CRAN list](https://github.com/akhikolla/RcppDeepState/blob/master/R/crancheck.R) has the code to list the packages that has bugs identified by CRAN tools.

```R

> unique(type.dt$pkg)
 [1] "AGread"              "bigmemory"           "BuyseTest" 
 [4] "cld2"                "cld3"                "compboost"
 [7] "dggridR"             "DStree"              "fastAdaboost"
[10] "FLSSS"               "FRegSigCom"          "glamlasso"
[13] "glmmsr"              "GMKMcharlie"         "GreedySBTM" 
[16] "iptools"             "isotree"             "kernelboot"
[19] "later"               "lda.svi"             "milr"
[22] "mined"               "mixggm"              "OneArmPhaseTwoStudy"
[25] "pdftools"            "PP"                  "PRIMME" 
[28] "protolite"           "pts2polys"           "r2sundials"
[31] "RcppDE"              "Rdimtools"           "Rdtq" 
[34] "RMKL"                "rTRNG"               "sboost" 
[37] "Scalelink"           "scPDSI"              "scrypt"
[40] "TDA"                 "tesseract"           "TreeLS"
[43] "volesti"

```

### RcppDeepState checks on Rcpp Packages

RcppDeepState detected bugs in few Rcpp packages which CRAN failed to detect. The [RcppDeepState list](https://github.com/akhikolla/RcppDeepState/blob/master/R/logidentify.R) gives the list of packages that RcppDeepState detects the errors in.

Found errors in following packages(so far) using RcppDeepState

```R
> rcppdeepstate_list
 [1] "abcADM"           "accelerometry"    "adeba"            "AGread"
 [5] "alphabetr"        "ambient"          "amt"              "anytime" 
 [9] "aphid"            "aricode"          "autothresholdr"   "backbone"
[13] "BalancedSampling" "BAMBI"

```

The [Complete log files]() has the error log files which list the input along with the error trace for the functions in the packages.

1. **AGread** : RcppDeepState detected an Invalid read of size 4 in get_VM_C() function in the package. The error is shown below:

```c++
==10904== Invalid read of size 8
==10904==    at 0x42BD92: get_VM_C(Rcpp::Vector<14, Rcpp::PreserveStorage>, Rcpp::Vector<14, Rcpp::PreserveStorage>, Rcpp::Vector<14, Rcpp::PreserveStorage>) (get_VM_C.cpp:22)
==10904==    by 0x40A690: DeepState_Test_AGread_deepstate_test_get_VM_C_test() (get_VM_C_DeepState_TestHarness.cpp:28)
==10904==    by 0x40A348: DeepState_Run_AGread_deepstate_test_get_VM_C_test() (get_VM_C_DeepState_TestHarness.cpp:7)
==10904==    by 0x406CD3: DeepState_RunTest.isra.6 (in /home/akhila/Documents/compileAttributescheck/AGread/inst/testfiles/get_VM_C/get_VM_C_DeepState_TestHarness)
==10904==    by 0x4153EA: DeepState_FuzzOneTestCase (in /home/akhila/Documents/compileAttributescheck/AGread/inst/testfiles/get_VM_C/get_VM_C_DeepState_TestHarness)
==10904==    by 0x4154FF: DeepState_Fuzz (in /home/akhila/Documents/compileAttributescheck/AGread/inst/testfiles/get_VM_C/get_VM_C_DeepState_TestHarness)
==10904==    by 0x40781D: main (in /home/akhila/Documents/compileAttributescheck/AGread/inst/testfiles/get_VM_C/get_VM_C_DeepState_TestHarness)
==10904==  Address 0xba09720 is 0 bytes after a block of size 624 alloc'd
==10904==    at 0x4C2FB0F: malloc (in /usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==10904==    by 0x4FB8633: Rf_allocVector3 (memory.c:2766)
==10904==    by 0x42C17A: void Rcpp::Vector<14, Rcpp::PreserveStorage>::import_sugar_expression<true, Rcpp::sugar::Pow<14, true, Rcpp::Vector<14, Rcpp::PreserveStorage>, int> >(Rcpp::VectorBase<14, true, Rcpp::sugar::Pow<14, true, Rcpp::Vector<14, Rcpp::PreserveStorage>, int> > const&, Rcpp::traits::integral_constant<bool, false>) (Vector.h:1070)
==10904==    by 0x42C021: Rcpp::Vector<14, Rcpp::PreserveStorage>::Vector<true, Rcpp::sugar::Pow<14, true, Rcpp::Vector<14, Rcpp::PreserveStorage>, int> >(Rcpp::VectorBase<14, true, Rcpp::sugar::Pow<14, true, Rcpp::Vector<14, Rcpp::PreserveStorage>, int> > const&) (Vector.h:165)
==10904==    by 0x42BCC7: get_VM_C(Rcpp::Vector<14, Rcpp::PreserveStorage>, Rcpp::Vector<14, Rcpp::PreserveStorage>, Rcpp::Vector<14, Rcpp::PreserveStorage>) (get_VM_C.cpp:19)
==10904==    by 0x40A690: DeepState_Test_AGread_deepstate_test_get_VM_C_test() (get_VM_C_DeepState_TestHarness.cpp:28)
==10904==    by 0x40A348: DeepState_Run_AGread_deepstate_test_get_VM_C_test() (get_VM_C_DeepState_TestHarness.cpp:7)
==10904==    by 0x406CD3: DeepState_RunTest.isra.6 (in /home/akhila/Documents/compileAttributescheck/AGread/inst/testfiles/get_VM_C/get_VM_C_DeepState_TestHarness)
==10904==    by 0x4153EA: DeepState_FuzzOneTestCase (in /home/akhila/Documents/compileAttributescheck/AGread/inst/testfiles/get_VM_C/get_VM_C_DeepState_TestHarness)
==10904==    by 0x4154FF: DeepState_Fuzz (in /home/akhila/Documents/compileAttributescheck/AGread/inst/testfiles/get_VM_C/get_VM_C_DeepState_TestHarness)
==10904==    by 0x40781D: main (in /home/akhila/Documents/compileAttributescheck/AGread/inst/testfiles/get_VM_C/get_VM_C_DeepState_TestHarness)

```

Here the `Invalid read of size 8` means the memory that the process is trying to read is unavailable. Here the 8 bytes indicate the size of the memory that the process is trying to access.

The next error trace line showing `Address 0xba09720 is 0 bytes after a block of size 624 alloc'd` means that the address starting at the location 0xba09720, 0 bytes are allocated for a block of size 624 bytes.






