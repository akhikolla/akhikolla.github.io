I"¥<p><strong>Testing Rcpp packages using DeepState and Valgrind</strong></p>

<p>Testing Rcpp packages for memory violations can be tricky.</p>

<p>The C++ code embedded inside an Rcpp function can introduce subtle bugs. These bugs can be hard to detect because they donâ€™t throw any warnings or error messages when we compile and run the code but the behavior of the code changes every time we execute it.</p>

<p>R has its own memory manager whereas in C++ there is no built-in garbage collector to take care of its memory so we need to be extra careful in handling the memory and not to introduce any bugs.</p>

<p>The garbage collector needs to keep track of allocations and references. These create overhead in memory, performance, and the complexity of the language. This is the reason C++ is faster and has higher performance compared to other languages but this higher performance comes with a cost. Memory management in C++ is manual and this could result in undesirable behavior or bugs in most of the cases if not handled properly.</p>

<p><strong>Subtle Problems in CPP code:</strong></p>
<ol>
  <li>use after free</li>
  <li>use after delete</li>
  <li>referencing to a null pointer</li>
  <li>read from an undeclared/inaccessible memory</li>
  <li>write to an index out of bounds/inaccesible memory</li>
</ol>

<p>These errors may not always be detected. When we run any of the code with the above issues sometimes the code might not give any issues or it might give a normal output or it might crash the code, the output is not predictable and might keep changing depending on the working platforms as well.</p>

<p>The default build of R is designed in such a way to pass these memory issues by not throwing errors. Although there are knownÂ errors in the code R fails to detect them.Â </p>

<p>Hereâ€™s a simple example of Rcpp function that causes a segfault:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="cp">#include &lt;Rcpp.h&gt;
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">void</span> <span class="nf">rcpp_write_to_null</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">double</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>Here the error is obvious that weâ€™re creating a pointer of type double and assigning it to zero which means we are creating a null pointer. A null pointer is never a valid address location. If we ever try to dereference the null pointer we will get a segmentation fault.</p>

<p>Running the above code gives something like this:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="n">rcpp_write_to_null</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="o">***</span> <span class="n">caught</span> <span class="n">segfault</span> <span class="o">***</span> 
<span class="o">&gt;</span> <span class="n">address</span> <span class="p">(</span><span class="n">nil</span><span class="p">),</span> <span class="n">cause</span> <span class="err">'</span><span class="n">memory</span> <span class="n">not</span> <span class="n">mapped</span><span class="err">'</span>
<span class="o">&gt;</span> <span class="n">Traceback</span><span class="o">:</span>
<span class="o">&gt;</span> <span class="mi">1</span><span class="o">:</span><span class="n">rcpp_write_to_null</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">An</span> <span class="n">irrecoverable</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">.</span> <span class="n">R</span> <span class="n">is</span> <span class="n">aborting</span> <span class="n">now</span> <span class="p">...</span>
<span class="o">&gt;</span> <span class="n">Segmentation</span> <span class="n">fault</span> <span class="p">(</span><span class="n">core</span> <span class="n">dumped</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Although R detects that we are trying to access an invalid memory location by throwing a segmentation fault but it is unable to give us the exact useful information, it missed where the error occurred and why R is aborting.</p>

<p>Many other errors might occur when working with Rcpp code, R might not be able to detect them in the first run.</p>

<p><strong>Detecting Memory Issues in Rcpp:</strong></p>

<p>Today weâ€™re going to look at the various tools that can help us detect various memory issues in Rcpp packages:Â </p>

<p><strong>Sanitizers :</strong></p>

<p>We can use sanitizers to detect various kinds of memory problems in our Rcpp functions. Compiling your Rcpp functions with Address sanitizer can detect memory problems like :</p>

<ul>
  <li>Use of Deallocated/freed Memory</li>
  <li>Deallocation of Deallocated Memory</li>
  <li>Deallocation of Nonallocated Memory</li>
  <li>Use of Stack Memory after function return</li>
  <li>Use of Out-of-Scope Stack Memory</li>
  <li>Overflow and Underflow of Buffers</li>
</ul>

<p>Address sanitizer combined with memory sanitizer can detect the use of uninitialized memory as well.</p>

<p>Similarly, Undefined behavior sanitizer detects some other forms of undefined behavior.UBSAN can detect error like</p>

<ul>
  <li>Invalid Float Cast</li>
  <li>Division where the divisor is zero</li>
  <li>When a null value is incorrectly passed as an argument</li>
  <li>When a function incorrectly returns a null value</li>
  <li>When a null value is incorrectly assigned to a variable</li>
  <li>The creation of null references and null pointer dereferences</li>
  <li>Invalid pointer casts due to differences in the sizes of types</li>
  <li>Invalid and overflowing shifts,array bounds that arenâ€™t positive.</li>
</ul>

<p>Using these sanitizers in your build is as easy as adding -fsanitize flag with respective type. For ASAN we use <code class="language-plaintext highlighter-rouge">-fsanitize=address</code> and for UBSAN it is <code class="language-plaintext highlighter-rouge">-fsanitize=undefined</code>.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">R_HOME</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">R</span>
<span class="n">COMMON_FLAGS</span><span class="o">=</span> <span class="n">DeepState_TestHarness</span><span class="p">.</span><span class="n">o</span>  <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">RcppDeepState</span><span class="o">/</span><span class="n">include</span><span class="o">/</span> <span class="o">-</span><span class="n">L</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">library</span><span class="o">/</span><span class="n">RInside</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">lib</span> <span class="o">-</span><span class="n">Wl</span><span class="p">,</span><span class="o">-</span><span class="n">rpath</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">library</span><span class="o">/</span><span class="n">RInside</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">lib</span> <span class="o">-</span><span class="n">L</span><span class="err">$</span><span class="p">{</span><span class="n">R_HOME</span><span class="p">}</span><span class="o">/</span><span class="n">lib</span> <span class="o">-</span><span class="n">Wl</span><span class="p">,</span><span class="o">-</span><span class="n">rpath</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">R_HOME</span><span class="p">}</span><span class="o">/</span><span class="n">lib</span> <span class="o">-</span><span class="n">L</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">deepstate</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span> <span class="o">-</span><span class="n">Wl</span><span class="p">,</span><span class="o">-</span><span class="n">rpath</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">deepstate</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span> <span class="o">-</span><span class="n">lR</span> <span class="o">-</span><span class="n">lRInside</span> <span class="o">-</span><span class="n">ldeepstate</span>
<span class="n">DeepState_TestHarness</span> <span class="o">:</span> <span class="n">DeepState_TestHarness</span><span class="p">.</span><span class="n">o</span>
	 <span class="n">clang</span><span class="o">++</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">fsanitize</span><span class="o">=</span><span class="n">address</span> <span class="o">-</span><span class="n">o</span> <span class="n">deallocate_DeepState_TestHarness</span> <span class="err">$</span><span class="p">{</span><span class="n">COMMON_FLAGS</span><span class="p">}</span> <span class="o">~/</span><span class="n">R</span><span class="o">/</span><span class="n">testpackage</span><span class="o">/</span><span class="n">src</span><span class="o">/*</span><span class="p">.</span><span class="n">o</span>

<span class="n">DeepState_TestHarness</span><span class="p">.</span><span class="n">o</span> <span class="o">:</span> <span class="n">DeepState_TestHarness</span><span class="p">.</span><span class="n">cpp</span>
	 <span class="n">clang</span><span class="o">++</span> <span class="o">-</span><span class="n">g</span> <span class="o">-</span><span class="n">fsanitize</span><span class="o">=</span><span class="n">address</span> <span class="o">-</span><span class="n">fno</span><span class="o">-</span><span class="n">omit</span><span class="o">-</span><span class="n">frame</span><span class="o">-</span><span class="n">pointer</span> <span class="o">-</span><span class="n">I</span><span class="err">$</span><span class="p">{</span><span class="n">R_HOME</span><span class="p">}</span><span class="o">/</span><span class="n">include</span> <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">deepstate</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">include</span> <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">library</span><span class="o">/</span><span class="n">Rcpp</span><span class="o">/</span><span class="n">include</span> <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">site</span><span class="o">-</span><span class="n">library</span><span class="o">/</span><span class="n">RInside</span><span class="o">/</span><span class="n">include</span> <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">RcppDeepState</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span> <span class="n">DeepState_TestHarness</span><span class="p">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">o</span> <span class="n">DeepState_TestHarness</span><span class="p">.</span><span class="n">o</span> <span class="o">-</span><span class="n">c</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>Although sanitizers help us detect most of the memory errors in the code it fails to detect a few of them in a default R build. As not all the errors are getting identified in the default R build we will have to run our code with R-devel build which will be discussed in the next segment.</p>

<p><strong>Significant Builds of R :</strong></p>

<p>There are certain builds in R which can help us detect these memory and undefined behavior errors. This is because the regular build of R is designed in such a way to neglect these kinds of issues as it is an optimized version.</p>

<p>The easiest way to get these builds is to install them from the docker container. You can refer to <a href="http://dirk.eddelbuettel.com/code/sanitizers.html">sanitizers</a> it has excellent information on how to use R-devel build with address sanitizers and undefined sanitizers.</p>

<p>The rocker container provides the following builds to test code using ASAN and UBSAN:
ASAN enabled build of R-devel: r-devel-san.
UBSAN enabled build of R-devel : r-devel-ubsan.</p>

<p><strong>Limitations:</strong></p>

<ol>
  <li>Using docker could be overhead.</li>
  <li>As we are trying to test code run in default R build changing build of R to detect those errors could lose its purpose and is not always a good idea.</li>
</ol>

<p>Also, we have rhub() platform which could help us detect any issues in the Rcpp packages, it checks the package in the Rdevel version.</p>

<p><strong>Valgrind :</strong></p>

<p>Valgrind is usually run during the run time unlike sanitizers during compile time. It helps us detect memory errors and leaks in the code. Valgrind works with default build of R, unlike sanitizers. But using Valgrind on the R build could slower its performance. As we run our code with Valgrind we get the stack trace of the error occurred and the reason for the error and its location.</p>

<p>There are certain tools that Valgrind uses to detect these memory errors, one such tool is memcheck used as <code class="language-plaintext highlighter-rouge">--tool=memcheck</code> and another is leak-check used as <code class="language-plaintext highlighter-rouge">--leak-check=full</code>.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">valgrind</span> <span class="o">--</span><span class="n">tool</span><span class="o">=</span><span class="n">memcheck</span> <span class="o">--</span><span class="n">leak</span><span class="o">-</span><span class="n">check</span><span class="o">=</span><span class="n">yes</span> <span class="p">.</span><span class="o">/</span><span class="n">LOPART_interface_DeepState_TestHarness</span> <span class="o">--</span><span class="n">fuzz</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>As we are working with DeepState in Rcpp packages we need to take care of two things :</p>

<ol>
  <li>We have to make sure to create a TestHarness for each function in the package.</li>
  <li>Also, Make a call to the respective Rcpp function and pass corresponding randomized parameters with the RcppDeepState functions in RcppDeepState.h in the TestHarness.</li>
</ol>

<p>Once we have the TestHarness created for every function in the Rcpp package, all we have to do is run the testharness with Valgrind and use memcheck and leak check tools to detect any memory leaks in the code.</p>

<p>The process can be done in 3 simple steps:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="cp"># load RcppDeepState library
</span><span class="n">library</span><span class="p">(</span><span class="n">RcppDeepState</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">RcppDeepState</span><span class="o">::</span><span class="n">deepstate_pkg_create</span><span class="p">(</span><span class="s">"pathtopackage"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Making a call to deepstate_pkg_create function creates TestHarness and their corresponding Makefiles for each function in the package</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">RcppDeepState</span><span class="o">::</span><span class="n">deepstate_compile_run</span><span class="p">(</span><span class="s">"pathtopackage"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Making a call to deepstate_compile_run function compiles the code with all the required flags and libraries and executes the code with Valgrind. After executing the code we save the results of the Valgrind into a log file.</p>

<p><strong>Use after Deallocate :</strong></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>
<span class="cp">#include &lt;Rcpp.h&gt;
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">int</span> <span class="nf">rcpp_use_after_deallocate</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">){</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">val</span><span class="p">];</span>
  <span class="k">delete</span><span class="p">[]</span> <span class="n">x</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="p">}</span> 
  
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Considering input is always positive and here we are trying to use the memory after it is deleted which is a known failure.
When we run this function in R it gives something like this:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="n">rcpp_use_after_deallocate</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="mi">86</span>
<span class="o">&gt;</span> <span class="n">rcpp_use_after_deallocate</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="mi">86</span>
<span class="o">&gt;</span> <span class="n">rcpp_use_after_deallocate</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="mi">86</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>If we observe above we are getting the same output for any input although those memory locations are not allocated or initialized. We still get some garbage value instead of an error.</p>

<p>But creating a testharness for this function and passing deepstate values and memory check under Valgrind gives the following error:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre>
<span class="n">INFO</span><span class="o">:</span> <span class="n">Starting</span> <span class="n">fuzzing</span>
<span class="n">WARNING</span><span class="o">:</span> <span class="n">No</span> <span class="n">seed</span> <span class="n">provided</span><span class="p">;</span> <span class="k">using</span> <span class="mi">1591573220</span>
<span class="n">WARNING</span><span class="o">:</span> <span class="n">No</span> <span class="n">test</span> <span class="n">specified</span><span class="p">,</span> <span class="n">defaulting</span> <span class="n">to</span> <span class="n">first</span> <span class="n">test</span> <span class="n">defined</span> <span class="p">(</span><span class="n">use_after_deallocate_random_datatypes_rcpp_use_after_deallocate_test</span><span class="p">)</span>
<span class="n">size</span> <span class="n">values</span><span class="o">:</span> <span class="mi">2049359586</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span> <span class="n">Invalid</span> <span class="n">read</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">1</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">at</span> <span class="mh">0x418604</span><span class="o">:</span> <span class="n">rcpp_use_after_deallocate</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">use_after_deallocate</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">7</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x4082AD</span><span class="o">:</span> <span class="n">DeepState_Test_use_after_deallocate_random_datatypes_rcpp_use_after_deallocate_test</span><span class="p">()</span> <span class="p">(</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">16</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x408188</span><span class="o">:</span> <span class="n">DeepState_Run_use_after_deallocate_random_datatypes_rcpp_use_after_deallocate_test</span><span class="p">()</span><span class="o">-</span> <span class="p">(</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">7</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x405D43</span><span class="o">:</span> <span class="n">DeepState_RunTest</span><span class="p">.</span><span class="n">isra</span><span class="mf">.6</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40E27A</span><span class="o">:</span> <span class="n">DeepState_FuzzOneTestCase</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40E38F</span><span class="o">:</span> <span class="n">DeepState_Fuzz</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40631D</span><span class="o">:</span> <span class="n">main</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>  <span class="n">Address</span> <span class="mh">0x59e43045</span> <span class="n">is</span> <span class="mi">5</span> <span class="n">bytes</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">block</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">2</span><span class="p">,</span><span class="mo">04</span><span class="mi">9</span><span class="p">,</span><span class="mi">359</span><span class="p">,</span><span class="mi">586</span> <span class="n">free</span><span class="err">'</span><span class="n">d</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">at</span> <span class="mh">0x4C3173B</span><span class="o">:</span> <span class="k">operator</span> <span class="k">delete</span><span class="p">[](</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">valgrind</span><span class="o">/</span><span class="n">vgpreload_memcheck</span><span class="o">-</span><span class="n">amd64</span><span class="o">-</span><span class="n">linux</span><span class="p">.</span><span class="n">so</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x418603</span><span class="o">:</span> <span class="n">rcpp_use_after_deallocate</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">use_after_deallocate</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">6</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x4082AD</span><span class="o">:</span> <span class="n">DeepState_Test_use_after_deallocate_random_datatypes_rcpp_use_after_deallocate_test</span><span class="p">()</span> <span class="p">(</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">16</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x408188</span><span class="o">:</span> <span class="n">DeepState_Run_use_after_deallocate_random_datatypes_rcpp_use_after_deallocate_test</span><span class="p">()</span> <span class="p">(</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">7</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x405D43</span><span class="o">:</span> <span class="n">DeepState_RunTest</span><span class="p">.</span><span class="n">isra</span><span class="mf">.6</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40E27A</span><span class="o">:</span> <span class="n">DeepState_FuzzOneTestCase</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40E38F</span><span class="o">:</span> <span class="n">DeepState_Fuzz</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40631D</span><span class="o">:</span> <span class="n">main</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>  <span class="n">Block</span> <span class="n">was</span> <span class="n">alloc</span><span class="err">'</span><span class="n">d</span> <span class="n">at</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">at</span> <span class="mh">0x4C3089F</span><span class="o">:</span> <span class="k">operator</span> <span class="k">new</span><span class="p">[](</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">valgrind</span><span class="o">/</span><span class="n">vgpreload_memcheck</span><span class="o">-</span><span class="n">amd64</span><span class="o">-</span><span class="n">linux</span><span class="p">.</span><span class="n">so</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x4185F8</span><span class="o">:</span> <span class="n">rcpp_use_after_deallocate</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">use_after_deallocate</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">5</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x4082AD</span><span class="o">:</span> <span class="n">DeepState_Test_use_after_deallocate_random_datatypes_rcpp_use_after_deallocate_test</span><span class="p">()</span> <span class="p">(</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">16</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x408188</span><span class="o">:</span> <span class="n">DeepState_Run_use_after_deallocate_random_datatypes_rcpp_use_after_deallocate_test</span><span class="p">()</span> <span class="p">(</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">7</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x405D43</span><span class="o">:</span> <span class="n">DeepState_RunTest</span><span class="p">.</span><span class="n">isra</span><span class="mf">.6</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40E27A</span><span class="o">:</span> <span class="n">DeepState_FuzzOneTestCase</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40E38F</span><span class="o">:</span> <span class="n">DeepState_Fuzz</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40631D</span><span class="o">:</span> <span class="n">main</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">use_after_deallocate_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span> 
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span> 
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span> <span class="n">HEAP</span> <span class="n">SUMMARY</span><span class="o">:</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>     <span class="n">in</span> <span class="n">use</span> <span class="n">at</span> <span class="n">exit</span><span class="o">:</span> <span class="mi">50</span><span class="p">,</span><span class="mi">292</span><span class="p">,</span><span class="mi">267</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">9</span><span class="p">,</span><span class="mi">713</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>   <span class="n">total</span> <span class="n">heap</span> <span class="n">usage</span><span class="o">:</span> <span class="mi">27</span><span class="p">,</span><span class="mi">722</span> <span class="n">allocs</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span><span class="mo">00</span><span class="mi">9</span> <span class="n">frees</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">135</span><span class="p">,</span><span class="mi">357</span><span class="p">,</span><span class="mi">440</span> <span class="n">bytes</span> <span class="n">allocated</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span> 
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span> <span class="n">LEAK</span> <span class="n">SUMMARY</span><span class="o">:</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">definitely</span> <span class="n">lost</span><span class="o">:</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">0</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">indirectly</span> <span class="n">lost</span><span class="o">:</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">0</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>      <span class="n">possibly</span> <span class="n">lost</span><span class="o">:</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">0</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>    <span class="n">still</span> <span class="n">reachable</span><span class="o">:</span> <span class="mi">50</span><span class="p">,</span><span class="mi">292</span><span class="p">,</span><span class="mi">267</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">9</span><span class="p">,</span><span class="mi">713</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>                       <span class="n">of</span> <span class="n">which</span> <span class="n">reachable</span> <span class="n">via</span> <span class="n">heuristic</span><span class="o">:</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>                         <span class="n">newarray</span>           <span class="o">:</span> <span class="mi">4</span><span class="p">,</span><span class="mi">264</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">1</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span>         <span class="n">suppressed</span><span class="o">:</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">0</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span> <span class="n">Reachable</span> <span class="n">blocks</span> <span class="p">(</span><span class="n">those</span> <span class="n">to</span> <span class="n">which</span> <span class="n">a</span> <span class="n">pointer</span> <span class="n">was</span> <span class="n">found</span><span class="p">)</span> <span class="n">are</span> <span class="n">not</span> <span class="n">shown</span><span class="p">.</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span> <span class="n">To</span> <span class="n">see</span> <span class="n">them</span><span class="p">,</span> <span class="n">rerun</span> <span class="n">with</span><span class="o">:</span> <span class="o">--</span><span class="n">leak</span><span class="o">-</span><span class="n">check</span><span class="o">=</span><span class="n">full</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">leak</span><span class="o">-</span><span class="n">kinds</span><span class="o">=</span><span class="n">all</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span> 
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span> <span class="n">For</span> <span class="n">counts</span> <span class="n">of</span> <span class="n">detected</span> <span class="n">and</span> <span class="n">suppressed</span> <span class="n">errors</span><span class="p">,</span> <span class="n">rerun</span> <span class="n">with</span><span class="o">:</span> <span class="o">-</span><span class="n">v</span>
<span class="o">==</span><span class="mi">7136</span><span class="o">==</span> <span class="n">ERROR</span> <span class="n">SUMMARY</span><span class="o">:</span> <span class="mi">1</span> <span class="n">errors</span> <span class="n">from</span> <span class="mi">1</span> <span class="n">contexts</span> <span class="p">(</span><span class="n">suppressed</span><span class="o">:</span> <span class="mi">0</span> <span class="n">from</span> <span class="mi">0</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>If we break down this log file output into steps we get the stack trace:</p>

<blockquote>
  <p>Invalid read of size 1</p>
</blockquote>

<p>Valgrind detects where exactly there is an invalid read, It caught that we attempted to perform an invalid read of size one i.e of x[5] at line 7 in our rcpp_use_after_deallocate function. We can also the see traceback of the rcpp function call in the TestHarness at line 16 (use_after_deallocate_DeepState_TestHarness.cpp:16)</p>

<blockquote>
  <p>Address 0x59e43045 is 5 bytes inside a block of size 2,049,359,586 freeâ€™d:</p>
</blockquote>

<p>It also gives information about the number of bytes that are freeâ€™d with operator delete[] at line 6 in rcpp_use_after_deallocate(int)</p>

<blockquote>
  <p>Block was allocâ€™d:</p>
</blockquote>

<p>It gives information about the array created using operator new[] at line 5 in rcpp_use_after_deallocate(int)</p>

<p><strong>Read out of bounds :</strong></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="cp">#include &lt;Rcpp.h&gt;
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">int</span> <span class="nf">rcpp_read_out_of_bound</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">){</span>
  <span class="kt">int</span> <span class="o">*</span><span class="n">stack_array</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="n">val</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">stack_array</span><span class="p">[</span><span class="n">val</span><span class="o">+</span><span class="mi">100</span><span class="p">];</span>
  	
<span class="p">}</span> 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Here we are trying to read a value from an array index which is out of bound to stack_array. Assuming the input is greater than zero when we run the code in R we get something like :</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="n">testcase</span><span class="o">::</span><span class="n">rcpp_read_out_of_bound</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="mi">296227088</span>
<span class="o">&gt;</span> <span class="n">testcase</span><span class="o">::</span><span class="n">rcpp_read_out_of_bound</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="mi">5</span>
<span class="o">&gt;</span> <span class="n">testcase</span><span class="o">::</span><span class="n">rcpp_read_out_of_bound</span><span class="p">(</span><span class="mi">52</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="mi">796026227</span>
<span class="o">&gt;</span> <span class="n">testcase</span><span class="o">::</span><span class="n">rcpp_read_out_of_bound</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="mi">32723</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>We are trying to access the value at an index that doesnâ€™t exist but R fails to detect that. When we call the function we get different outputs mostly garbage values for every input instead of R detecting the error.</p>

<p>When we run the code using Valgrind it throws the error as below:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="nl">INFO:</span> <span class="n">Starting</span> <span class="n">fuzzing</span>
<span class="n">WARNING</span><span class="o">:</span> <span class="n">No</span> <span class="n">seed</span> <span class="n">provided</span><span class="p">;</span> <span class="k">using</span> <span class="mi">1591571071</span>
<span class="n">WARNING</span><span class="o">:</span> <span class="n">No</span> <span class="n">test</span> <span class="n">specified</span><span class="p">,</span> <span class="n">defaulting</span> <span class="n">to</span> <span class="n">first</span> <span class="n">test</span> <span class="n">defined</span> <span class="p">(</span><span class="n">read_out_of_bound_random_datatypes_rcpp_read_out_of_bound_test</span><span class="p">)</span>
<span class="n">sizeofarray</span> <span class="n">values</span><span class="o">:</span> <span class="mi">1454661619</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> <span class="n">Invalid</span> <span class="n">read</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">4</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">at</span> <span class="mh">0x4185D3</span><span class="o">:</span> <span class="n">rcpp_read_out_of_bound</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">read_out_of_bound</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">9</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x4082AD</span><span class="o">:</span> <span class="n">DeepState_Test_read_out_of_bound_random_datatypes_rcpp_read_out_of_bound_test</span><span class="p">()</span> <span class="p">(</span><span class="n">read_out_of_bound_DeepState_TestHarness</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">16</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x408188</span><span class="o">:</span> <span class="n">DeepState_Run_read_out_of_bound_random_datatypes_rcpp_read_out_of_bound_test</span><span class="p">()</span> <span class="p">(</span><span class="n">read_out_of_bound_DeepState_TestHarness</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">7</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x405D43</span><span class="o">:</span> <span class="n">DeepState_RunTest</span><span class="p">.</span><span class="n">isra</span><span class="mf">.6</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">read_out_of_bound_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40E27A</span><span class="o">:</span> <span class="n">DeepState_FuzzOneTestCase</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">read_out_of_bound_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40E38F</span><span class="o">:</span> <span class="n">DeepState_Fuzz</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">read_out_of_bound_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40631D</span><span class="o">:</span> <span class="n">main</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">read_out_of_bound_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>  <span class="n">Address</span> <span class="mh">0x1b4b5b19c</span> <span class="n">is</span> <span class="mi">5</span><span class="p">,</span><span class="mi">818</span><span class="p">,</span><span class="mi">646</span><span class="p">,</span><span class="mi">876</span> <span class="n">bytes</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">block</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">5</span><span class="p">,</span><span class="mi">818</span><span class="p">,</span><span class="mi">650</span><span class="p">,</span><span class="mi">528</span> <span class="n">in</span> <span class="n">arena</span> <span class="s">"client"</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> 
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> 
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> <span class="n">HEAP</span> <span class="n">SUMMARY</span><span class="o">:</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>     <span class="n">in</span> <span class="n">use</span> <span class="n">at</span> <span class="n">exit</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span><span class="mi">868</span><span class="p">,</span><span class="mi">938</span><span class="p">,</span><span class="mi">743</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">9</span><span class="p">,</span><span class="mi">714</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>   <span class="n">total</span> <span class="n">heap</span> <span class="n">usage</span><span class="o">:</span> <span class="mi">27</span><span class="p">,</span><span class="mi">722</span> <span class="n">allocs</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span><span class="mo">00</span><span class="mi">8</span> <span class="n">frees</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span><span class="mi">904</span><span class="p">,</span><span class="mi">644</span><span class="p">,</span><span class="mi">330</span> <span class="n">bytes</span> <span class="n">allocated</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> 
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> <span class="mi">5</span><span class="p">,</span><span class="mi">818</span><span class="p">,</span><span class="mi">646</span><span class="p">,</span><span class="mi">476</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">1</span> <span class="n">blocks</span> <span class="n">are</span> <span class="n">possibly</span> <span class="n">lost</span> <span class="n">in</span> <span class="n">loss</span> <span class="n">record</span> <span class="mi">1</span><span class="p">,</span><span class="mi">306</span> <span class="n">of</span> <span class="mi">1</span><span class="p">,</span><span class="mi">306</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">at</span> <span class="mh">0x4C3089F</span><span class="o">:</span> <span class="k">operator</span> <span class="k">new</span><span class="p">[](</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">valgrind</span><span class="o">/</span><span class="n">vgpreload_memcheck</span><span class="o">-</span><span class="n">amd64</span><span class="o">-</span><span class="n">linux</span><span class="p">.</span><span class="n">so</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x4185D2</span><span class="o">:</span> <span class="n">rcpp_read_out_of_bound</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">read_out_of_bound</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">8</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x4082AD</span><span class="o">:</span> <span class="n">DeepState_Test_read_out_of_bound_random_datatypes_rcpp_read_out_of_bound_test</span><span class="p">()</span> <span class="p">(</span><span class="n">read_out_of_bound_DeepState_TestHarness</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">16</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x408188</span><span class="o">:</span> <span class="n">DeepState_Run_read_out_of_bound_random_datatypes_rcpp_read_out_of_bound_test</span><span class="p">()</span> <span class="p">(</span><span class="n">read_out_of_bound_DeepState_TestHarness</span><span class="p">.</span><span class="n">cpp</span><span class="o">:</span><span class="mi">7</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x405D43</span><span class="o">:</span> <span class="n">DeepState_RunTest</span><span class="p">.</span><span class="n">isra</span><span class="mf">.6</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">read_out_of_bound_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40E27A</span><span class="o">:</span> <span class="n">DeepState_FuzzOneTestCase</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">read_out_of_bound_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40E38F</span><span class="o">:</span> <span class="n">DeepState_Fuzz</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">read_out_of_bound_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">by</span> <span class="mh">0x40631D</span><span class="o">:</span> <span class="n">main</span> <span class="p">(</span><span class="n">in</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">akhila</span><span class="o">/</span><span class="n">R</span><span class="o">/</span><span class="n">testUBSAN</span><span class="o">/</span><span class="n">inst</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">read_out_of_bound_DeepState_TestHarness</span><span class="p">)</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> 
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> <span class="n">LEAK</span> <span class="n">SUMMARY</span><span class="o">:</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">definitely</span> <span class="n">lost</span><span class="o">:</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">0</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">indirectly</span> <span class="n">lost</span><span class="o">:</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">0</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>      <span class="n">possibly</span> <span class="n">lost</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span><span class="mi">818</span><span class="p">,</span><span class="mi">646</span><span class="p">,</span><span class="mi">476</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">1</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>    <span class="n">still</span> <span class="n">reachable</span><span class="o">:</span> <span class="mi">50</span><span class="p">,</span><span class="mi">292</span><span class="p">,</span><span class="mi">267</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">9</span><span class="p">,</span><span class="mi">713</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>                       <span class="n">of</span> <span class="n">which</span> <span class="n">reachable</span> <span class="n">via</span> <span class="n">heuristic</span><span class="o">:</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>                         <span class="n">newarray</span>           <span class="o">:</span> <span class="mi">4</span><span class="p">,</span><span class="mi">264</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">1</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span>         <span class="n">suppressed</span><span class="o">:</span> <span class="mi">0</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mi">0</span> <span class="n">blocks</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> <span class="n">Reachable</span> <span class="n">blocks</span> <span class="p">(</span><span class="n">those</span> <span class="n">to</span> <span class="n">which</span> <span class="n">a</span> <span class="n">pointer</span> <span class="n">was</span> <span class="n">found</span><span class="p">)</span> <span class="n">are</span> <span class="n">not</span> <span class="n">shown</span><span class="p">.</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> <span class="n">To</span> <span class="n">see</span> <span class="n">them</span><span class="p">,</span> <span class="n">rerun</span> <span class="n">with</span><span class="o">:</span> <span class="o">--</span><span class="n">leak</span><span class="o">-</span><span class="n">check</span><span class="o">=</span><span class="n">full</span> <span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">leak</span><span class="o">-</span><span class="n">kinds</span><span class="o">=</span><span class="n">all</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> 
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> <span class="n">For</span> <span class="n">counts</span> <span class="n">of</span> <span class="n">detected</span> <span class="n">and</span> <span class="n">suppressed</span> <span class="n">errors</span><span class="p">,</span> <span class="n">rerun</span> <span class="n">with</span><span class="o">:</span> <span class="o">-</span><span class="n">v</span>
<span class="o">==</span><span class="mi">6735</span><span class="o">==</span> <span class="n">ERROR</span> <span class="n">SUMMARY</span><span class="o">:</span> <span class="mi">2</span> <span class="n">errors</span> <span class="n">from</span> <span class="mi">2</span> <span class="n">contexts</span> <span class="p">(</span><span class="n">suppressed</span><span class="o">:</span> <span class="mi">0</span> <span class="n">from</span> <span class="mi">0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>If we analyze the stack trace :</p>

<blockquote>
  <p>Invalid read of size 4</p>
</blockquote>

<p>It say there is an invalid read of size 4 as we are trying to access an integer index its size is 4, at line 9 in rcpp_read_out_of_bound(int) (read_out_of_bound.cpp:9). It also gives us the line number from where this rcpp_read_out_of_bound is called from in DeepState_TestHarness.
(read_out_of_bound_DeepState_TestHarness.cpp:16).</p>

<p>Valgrind can also detect errors like write out of bound, use after free, use of a zero-sized array, use of uninitialized values, use of null pointers. In the same way, Valgrind gives the stack trace for every error that it caught. This kind of information(a type of error, location of error) is really helpful in debugging the code. Once we have all the information it could be very easy for the user to rectify the error.</p>

<p>Now RcppDeepState supports testing your Rcpp packages in Travis. It is as easy as making a call to</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">library</span><span class="p">(</span><span class="n">RcppDeepState</span><span class="p">)</span>
<span class="n">RcppDeepState</span><span class="o">::</span><span class="n">deepstate_ci_setup</span><span class="p">(</span><span class="n">pathtopackage</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This function creates a .travis.yml file for your Rcpp package if it doesnâ€™t exist with the necessary r_packages and environment variables which makes it easy for any package developers to use RcppDeepState on Travis-CI.
The Most recent build for <a href="https://travis-ci.org/github/akhikolla/RcppDeepState/builds/704036361">RcppDeepState</a>.</p>

<p>It also generates a test-rcppdeepstate.R in the test directory and inside that test file we make a call to deepstate_pkg_create(pkg path) to create TestHarness for the rcpp functions in the package and deepstate_compile_run(pkg path) will compile and run the code and returns a list of error messages along with line numbers.</p>

<p>Also, if the list returned is empty it means your Rcpp package doesnâ€™t have any bugs. Yayyy!!!</p>

<p>I have used deepstate_ci_setup() to set up package LOPART for testing with RcppDeepState on Travis. This function creates the .travis.yml and test-rcppdeepstate.R with necessary functionalities.</p>

<p>Once the changes are pushed to the userâ€™s GitHub Travis build runs and executes the functions. If all the tests pass in the Travis build your package doesnâ€™t have any crashes/bugs. The recent Travis build of <a href="https://travis-ci.org/github/akhikolla/LOPART/builds/704049717">LOPART</a></p>

<p>Thanks to <a href="https://tdhock.github.io/blog/">Dr.Toby Dylan Hocking</a> for his support on the project.</p>
:ET